---
import Umbrella from "./icons/Umbrella.astro";
---

<script>
  import { range, random } from "lodash";

  const RAIN_DROPS_MAX_SIZE: number = 5;

  const createDrop = (container: Element): HTMLDivElement => {
    const rainDrop = document.createElement("div");
    // we remove 2px from the width and add 2px to the height of the drop to make it more beautiful
    const dropWidth = random(2, RAIN_DROPS_MAX_SIZE - 2);
    const dropDuration = random(100, 500);

    // we remove 2px from the width and add 2px to the height of the drop to make it more beautiful
    rainDrop.style = `
        height: ${dropWidth + 2}px;
        width: ${dropWidth}px;
        position: absolute;
        top: 0%;
        left: ${random(0, 100)}%;
        transform: translate(-50%, -50%);
        background: rgba(131, 180, 195);
        border-radius: 50%;
        animation: fall ${dropDuration}ms linear infinite;
        `;

    container.appendChild(rainDrop);
    return rainDrop;
  };

  const handleRain = (rainButton: Element) => {
    const rainDrops: HTMLDivElement[] = [];
    let rainDropsInterval: NodeJS.Timeout;

    const getIsRaining = () => {
      return (
        typeof localStorage !== "undefined" &&
        localStorage.getItem("rain") === "true"
      );
    };

    const setIsRaining = (value: boolean) => {
      if (typeof localStorage !== "undefined") {
        localStorage.setItem("rain", value ? "true" : "false");
      }
    };

    const startRain = () => {
      const particlesContainer = document.querySelector(
        "#weather-animations-container"
      ) as HTMLElement;
      if (!particlesContainer) return;

      // Use the document's total scrollable height for the rain fall distance
      const fallDistance = document.documentElement.scrollHeight;
      particlesContainer.style.setProperty(
        "--fall-distance",
        `${fallDistance}px`
      );

      rainDropsInterval = setInterval(() => {
        if (rainDrops.length < 1000) {
          range(15).forEach(() => {
            const rainDrop = createDrop(particlesContainer);
            rainDrops.push(rainDrop);
          });
        }
      }, 100);
      setIsRaining(true);
    };

    const clearRain = () => {
      clearInterval(rainDropsInterval);
      rainDrops.forEach((rainDrop) => {
        rainDrop.remove();
      });
      rainDrops.splice(0, rainDrops.length);
      setIsRaining(false);
    };

    // desktop
    rainButton.addEventListener("click", () => {
      if (getIsRaining()) {
        clearRain();
      } else {
        startRain();
      }
    });

    // mobile
    rainButton.addEventListener("touchend", (e) => {
      e.preventDefault();
      if (getIsRaining()) {
        clearRain();
      } else {
        startRain();
      }
    });

    // keep raining on page change
    if (getIsRaining()) {
      startRain();
    }
  };

  const rainButton = document.querySelector(".make-it-rain");
  if (rainButton) {
    handleRain(rainButton);
  }
</script>

<style>
  @keyframes fall {
    to {
      transform: translateY(var(--fall-distance, 100vh));
    }
  }

  .make-it-rain {
    width: 20px;
    height: 20px;
  }
</style>

<button class="make-it-rain">
  <Umbrella />
</button>
